import{q as M,s as E,a as I,d as x,aU as H,v as u,x as y,O as b,Q as T,R as B,N as f,T as m,S as P,$ as w,M as o,V as N,U as k,bv as F,bw as G,w as U,m as D,z as Q,C as z,F as V,I as J,J as R,E as q,K as Y,L as K,l as h}from"./index.js";import{p as v,U as C,d as W,g as X,b as Z}from"./xivapi.js";import{_ as O}from"./_plugin-vue_export-helper.js";const L=["tank","healer","dps","crafter","gatherer","none"],S=[24283,24284,24285,24286,24287,24288,24289,24290,24294,24295,24296,24297,24298,24299,24300,24301,24302,24303,24304,24305,24306,24307,24309,24310,24311,24312,24313,24315,24316,24317,24318],j=M("castingMonitor",{state:()=>{var t;return{castData:E({}),playerId:I(""),focusTargetId:I(""),partyData:[],config:{duration:Number(((t=v)==null?void 0:t.duration)||25)},lastPush:Date.now()}},getters:{partyDataFormatted(t){return t.partyData.sort((e,l)=>L.indexOf(C.jobToRole(C.jobEnumToJob(e.job)))-L.indexOf(C.jobToRole(C.jobEnumToJob(l.job))))},focusTargetCastArr(t){var e;return((e=t.castData)==null?void 0:e[t.focusTargetId])??[]}},actions:{testAction(){const t=S[Math.floor(Math.random()*S.length)];this.pushAction(Date.now(),14,"贤者技能随机",this.focusTargetId,t,1),setTimeout(()=>{this.pushAction(Date.now(),15,"贤者技能随机",this.focusTargetId,t)},1e3)},testItem(){this.pushAction(Date.now(),15,"item_11c7",this.focusTargetId,parseInt("20011C7",16))},testItemHQ(){this.pushAction(Date.now(),15,"item_f5407",this.focusTargetId,parseInt("20F5407",16))},testParty(t){this.handlePartyChanged({party:t?[{id:"10000001",name:"测试张三",job:24,inParty:!0,src:""},{id:"10000002",name:"测试李四",job:25,inParty:!0,src:""},{id:"10000004",name:"测试王五",job:19,inParty:!0,src:""},{id:"10000005",name:"测试赵六",job:23,inParty:!0,src:""},{id:"10000006",name:"测试孙七",job:39,inParty:!0,src:""},{id:"10000007",name:"测试周八",job:40,inParty:!0,src:""},{id:"10000008",name:"测试吴九",job:37,inParty:!0,src:""},{id:"10000009",name:"测试郑十",job:38,inParty:!0,src:""}]:[]})},async pushAction(t,e,l,a,d,c){var g;const p=/^(?:1|true|yes|on|open|enabled|undefined)$/i.test((g=v)==null?void 0:g.energySaving);if(this.partyData.length===0&&a===this.playerId||p&&a===this.focusTargetId||!p&&this.partyData.length>0&&this.partyData.find(i=>i.id===a)){let i,r=!1;/^(?:item|mount)_/.test(l)?(d=parseInt(l.replace(/^.+_/,""),16),d>983040&&(d=parseInt(d.toString().slice(-5),10),r=!0),i=l.replace(/_.+$/,"")):i="action",this.castData[a]||(this.castData[a]=[]);const _=Symbol();this.castData[a].push({time:t,logLine:e,src:"",class:"",key:_,APIData:{}}),this.lastPush=Date.now();const n=this.castData[a].find(s=>s.key===_);if(setTimeout(()=>{var s;(s=this.castData[a])==null||s.splice(this.castData[a].indexOf(n),1)},(c||this.config.duration)*1e3),/^unknown_/.test(l))n.src="https://cafemaker.wakingsands.com/i/000000/000405.png",n.class="action action-category-0";else if(d<1e5){const s=await W(i,d,["ID","Icon","ActionCategoryTargetID","Name","Description"]);if(n.APIData=s,n.src=await X((s==null?void 0:s.Icon)??"",r),i==="action"?n.class=`action action-category-${s==null?void 0:s.ActionCategoryTargetID}`:i==="item"?n.class="item"+(r?"HQ":""):i==="mount"&&(n.class="mount"),s.ActionCategoryTargetID===2||s.ActionCategoryTargetID===3){const $=this.castData[a].filter(A=>/action-category-[23]/.test(A.class)&&A.logLine!==14).at(-2);$&&(n.GCDCast=((n.time-$.time)/1e3).toFixed(2),parseFloat(n.GCDCast)>=2.55&&(n.GCDClass="wasted"))}}}},handleChangePrimaryPlayer(t){this.playerId=t.charID.toString(16).toUpperCase(),this.focusTargetId=this.playerId},handleLogLine(t){t.line[0]==="20"?this.pushAction(Date.parse(t.line[1]),14,t.line[5],t.line[2],parseInt(t.line[4],16),Number(t.line[8])):(t.line[0]==="21"||t.line[0]==="22"&&t.line[45]==="0")&&this.pushAction(Date.parse(t.line[1]),15,t.line[5],t.line[2],parseInt(t.line[4],16))},handlePartyChanged(t){if(t.party.length>0){this.partyData=t.party.filter(e=>e.inParty);for(const e in this.castData)Object.prototype.hasOwnProperty.call(this.castData,e)&&(this.partyData.find(l=>l.id===e)||Reflect.deleteProperty(this.castData,e));Object.keys(this.partyData).includes(this.focusTargetId)||(this.focusTargetId=this.playerId)}else this.focusTargetId=this.playerId,this.partyData.length=0},handleClickChangeTarget(t){var e;t===this.focusTargetId?this.focusTargetId=this.playerId:this.focusTargetId=t,/^(?:1|true|yes|on|open|enabled|undefined)$/i.test((e=v)==null?void 0:e.syncFocusWS)&&callOverlayHandler({call:"broadcast",source:"castMonitorOverlay",msg:{targetId:this.focusTargetId}})},handleBroadcastMessage(t){t.source==="castMonitorOverlay"&&t.msg.targetId&&(this.focusTargetId=t.msg.targetId)}}}),tt=t=>(F("data-v-60d2da6e"),t=t(),G(),t),et={"w-100vw":"",flex:"~ nowrap",class:"main"},at=["data-casterId"],st={class:"elhover"},nt=["innerHTML"],ot=["src"],rt=tt(()=>m("img",{class:"frame"},null,-1)),it=x({__name:"main",setup(t){const e=j(),l=Number(/^(?:1|true|yes|on|open|enabled)$/i.test(v.displayAA)),a=Number(/^(?:1|true|yes|on|open|enabled)$/i.test(v.displayGCDSpace));return(d,c)=>{const p=H;return u(),y("div",et,[(u(!0),y(b,null,T(o(e).castData,(g,i)=>(u(),y("div",{key:i,"data-casterId":i},[(u(!0),y(b,null,T(g,r=>(u(),B(p,{"raw-content":"",placement:"right-start",effect:"dark",transition:"",teleported:!1,"popper-class":"el-tooltip","show-arrow":!1,key:r.key},{content:f(()=>{var _;return[m("div",st,[m("strong",null,P(r.APIData.Name),1),m("div",{innerHTML:(_=r.APIData)==null?void 0:_.Description,style:{"white-space":"pre-line"}},null,8,nt)])]}),default:f(()=>[m("div",{class:w(`images ${r.class} logLine${r.logLine} displayAA${o(l)} displayGCD${o(a)}`),style:N(`--animeDuration: ${o(e).config.duration}s;opacity:${Number(o(e).focusTargetId===i)}`)},[m("img",{src:r.src,class:"action-icon",height:"40"},null,8,ot),rt,o(a)===1?(u(),y("span",{key:0,class:w(["GCDCast",r.GCDClass])},P((r==null?void 0:r.GCDCast)??""),3)):k("",!0)],6)]),_:2},1024))),128))],8,at))),128))])}}});const lt=O(it,[["__scopeId","data-v-60d2da6e"]]),ct={key:0,"z-100":"",flex:"~ gap0 wrap",class:"header-layout"},dt=["onClick"],pt={flex:"~ nowrap items-end",style:{"align-items":"flex-end",gap:"0.1rem"}},ut=["src"],ht=x({__name:"header",setup(t){var a;const e=j();U(()=>{e.partyData.forEach(async d=>{d.src=await Z(d.job)})});const l=/^(?:1|true|yes|on|open|enabled|undefined)$/i.test((a=v)==null?void 0:a.showHeader);return(d,c)=>o(l)?(u(),y("div",ct,[(u(!0),y(b,null,T(o(e).partyDataFormatted,(p,g)=>(u(),y("button",{key:g,onClick:i=>o(e).handleClickChangeTarget(p.id),class:w(["job-lists",o(e).focusTargetId===p.id?"job-lists-focus":""]),"p-0":"","m-0":""},[m("div",pt,[m("img",{src:p.src,style:{height:"1.25em"}},null,8,ut),D(" "+P(o(C).nameToFullName(o(C).jobEnumToJob(p.job)).simple2),1)])],10,dt))),128))])):k("",!0)}});const ft={class:"common-layout"},yt={key:0},gt=x({__name:"index",setup(t){const e=j(),l=location.href.indexOf("localhost")>-1;Q(()=>{addOverlayListener("ChangePrimaryPlayer",e.handleChangePrimaryPlayer),addOverlayListener("LogLine",e.handleLogLine),addOverlayListener("PartyChanged",e.handlePartyChanged),addOverlayListener("BroadcastMessage",e.handleBroadcastMessage),startOverlayEvents()}),z(()=>{removeOverlayListener("ChangePrimaryPlayer",e.handleChangePrimaryPlayer),removeOverlayListener("LogLine",e.handleLogLine),removeOverlayListener("PartyChanged",e.handlePartyChanged),removeOverlayListener("BroadcastMessage",e.handleBroadcastMessage)});const a=I(!1);return setInterval(()=>{a.value=Date.now()-e.lastPush<e.config.duration*2*1e3},1e3),(d,c)=>{const p=ht,g=V,i=lt,r=J,_=R,n=q;return Y((u(),y("div",ft,[h(_,{"items-center":""},{default:f(()=>[h(g,{class:"header-layout"},{default:f(()=>[h(p)]),_:1}),h(r,{"p-0":""},{default:f(()=>[h(i)]),_:1})]),_:1}),l?(u(),y("footer",yt,[h(n,{onClick:c[0]||(c[0]=s=>o(e).testParty(!0))},{default:f(()=>[D("虚假小队")]),_:1}),h(n,{onClick:c[1]||(c[1]=s=>o(e).testParty(!1))},{default:f(()=>[D("单人")]),_:1}),h(n,{onClick:c[2]||(c[2]=s=>o(e).testAction())},{default:f(()=>[D("Action")]),_:1}),h(n,{onClick:c[3]||(c[3]=s=>o(e).testItem())},{default:f(()=>[D("Item")]),_:1}),h(n,{onClick:c[4]||(c[4]=s=>o(e).testItemHQ())},{default:f(()=>[D("ItemHQ")]),_:1})])):k("",!0)],512)),[[K,o(a)]])}}});const Ct=O(gt,[["__scopeId","data-v-f9d31337"]]);export{Ct as default};
